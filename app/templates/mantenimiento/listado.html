{% extends "base.html" %}
{% block title %}Incidencias de mantenimiento{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0 text-uppercase text-secondary">Listado de incidencias de mantenimiento</h5>
  <div>
    <a href="{{ url_for('main.nueva_incidencia_mantenimiento') }}" class="btn btn-outline-primary">
      <i class="bi bi-plus-circle"></i> Nueva incidencia
    </a>
    <a href="{{ url_for('main.descargar_pdf_mantenimiento') }}" class="btn btn-outline-danger ms-2">
      <i class="bi bi-file-earmark-pdf"></i> Descargar PDF
    </a>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light text-start">
        <tr>
          <th>Ubicación</th>
          <th>Estado</th>
          <th>Prioridad</th>
          <th>Fecha</th>
          {% if es_admin %}<th>Docente</th>{% endif %}
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for inc in pendientes %}
        <tr>
          <td>{{ inc.ubicacion }}</td>
          <td>
            {% if inc.estado == 'Activa' %}
              <span class="badge bg-warning text-dark">Activa</span>
            {% elif inc.estado == 'Cancelada' %}
              <span class="badge bg-danger">Cancelada</span>
            {% endif %}
          </td>
          <td>
            {% if inc.prioridad == 'Alta' %}
              <span class="badge bg-danger">Alta</span>
            {% elif inc.prioridad == 'Normal' %}
              <span class="badge bg-primary">Normal</span>
            {% elif inc.prioridad == 'Baja' %}
              <span class="badge bg-secondary">Baja</span>
            {% endif %}
          </td>
          <td>{{ inc.fecha_hora.strftime('%d/%m/%Y %H:%M') }}</td>
          {% if es_admin %}<td>{{ usuarios_dict[inc.docente_id] }}</td>{% endif %}
          <td class="text-end">
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#descripcion{{ inc.id }}">
            <i class="bi bi-search"></i>
          </button>
            <a href="{{ url_for('main.editar_incidencia_mantenimiento', id=inc.id) }}" class="btn btn-sm btn-outline-warning">
              <i class="bi bi-pencil-square"></i>
            </a>
            {% if inc.estado == 'Activa' %}
            <form action="{{ url_for('main.cancelar_incidencia_mantenimiento', id=inc.id) }}" method="post" style="display:inline-block" onsubmit="return confirm('¿Cancelar esta incidencia?')">
              <button type="submit" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-x-circle"></i>
              </button>
            </form>
            {% endif %}
          </td>
        </tr>
        <tr class="collapse" id="descripcion{{ inc.id }}">
          <td colspan="7">
            <strong>Descripción:</strong> {{ inc.descripcion }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<h6 class="text-muted">Histórico de incidencias resueltas</h6>
<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light text-start">
        <tr>
          <th>Ubicación</th>
          <th>Prioridad</th>
          <th>Fecha</th>
          <th>Fecha resolución</th>
          {% if es_admin %}<th>Docente</th>{% endif %}
            <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for inc in resueltas.items %}
        <tr>
          <td>{{ inc.ubicacion }}</td>
          <td>
            {% if inc.prioridad == 'Alta' %}
              <span class="badge bg-danger">Alta</span>
            {% elif inc.prioridad == 'Normal' %}
              <span class="badge bg-primary">Normal</span>
            {% elif inc.prioridad == 'Baja' %}
              <span class="badge bg-secondary">Baja</span>
            {% endif %}
          </td>
          <td>{{ inc.fecha_hora.strftime('%d/%m/%Y %H:%M') }}</td>
          <td>
            {% if inc.fecha_resolucion %}
              {{ inc.fecha_resolucion.strftime('%d/%m/%Y %H:%M') }}
            {% else %}
              -
            {% endif %}
          </td>
          {% if es_admin %}<td>{{ usuarios_dict[inc.docente_id] }}</td>{% endif %}
          <td>
              <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#descripcion{{ inc.id }}">
                <i class="bi bi-search"></i>
              </button>
          </td>
        </tr>
        <tr class="collapse" id="descripcion{{ inc.id }}">
            <td colspan="7">
                <strong>Descripción:</strong> {{ inc.descripcion }}
            </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="card-footer">
    {% if resueltas.has_prev %}
      <a href="{{ url_for('main.mostrar_incidencias_mantenimiento', page=resueltas.prev_num) }}" class="btn btn-outline-secondary btn-sm">Anterior</a>
    {% endif %}
    {% if resueltas.has_next %}
      <a href="{{ url_for('main.mostrar_incidencias_mantenimiento', page=resueltas.next_num) }}" class="btn btn-outline-secondary btn-sm float-end">Siguiente</a>
    {% endif %}
  </div>
</div>
{% endblock %}