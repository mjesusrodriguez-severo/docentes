{% extends "base.html" %}
{% block title %}Incidencias{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0 text-uppercase text-secondary">Listado de incidencias</h5>
  <a href="{{ url_for('main.nueva_incidencia') }}" class="btn btn-outline-primary">
    <i class="bi bi-plus-circle"></i> Nueva incidencia
  </a>
</div>

<div class="mb-3">
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-secondary filtro-estado active" data-estado="todos">Todos</button>
    <button type="button" class="btn btn-outline-warning filtro-estado" data-estado="Activa">Activas</button>
    <button type="button" class="btn btn-outline-secondary filtro-estado" data-estado="En curso">En curso</button> <!-- NUEVO -->
    <button type="button" class="btn btn-outline-success filtro-estado" data-estado="Resuelta">Resueltas</button>
    <button type="button" class="btn btn-outline-danger filtro-estado" data-estado="Cancelada">Canceladas</button>
  </div>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light text-start">
        <tr>
          <th>Ubicación</th>
          <th>Equipo</th>
          <th>Estado</th>
          <th>Prioridad</th>
          <th>Fecha</th>
          {% if es_tic %}
            <th>Docente</th>
          {% endif %}
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for inc in incidencias %}
        <tr class="incidencia-row" data-estado="{{ inc.estado }}" data-fecha="{{ inc.fecha_hora.isoformat() }}">
          <td>{{ inc.ubicacion }}</td>
          <td>{{ inc.equipo.nombre }}</td>
          <td>
              {% if inc.estado == 'Activa' %}
                <span class="badge bg-warning text-dark">Activa</span>
              {% elif inc.estado == 'Resuelta' %}
                <span class="badge bg-success">Resuelta</span>
              {% elif inc.estado == 'Cancelada' %}
                <span class="badge bg-danger">Cancelada</span>
              {% else %}
                <span class="badge bg-secondary">{{ inc.estado }}</span>
              {% endif %}
          </td>
          <td>
              {% if inc.prioridad == 'Alta' %}
                <span class="badge bg-danger">Alta</span>
              {% elif inc.prioridad == 'Normal' %}
                <span class="badge bg-primary">Normal</span>
              {% elif inc.prioridad == 'Baja' %}
                <span class="badge bg-secondary">Baja</span>
              {% else %}
                <span class="badge bg-light text-dark">{{ inc.prioridad }}</span>
              {% endif %}
          </td>
          <td>{{ inc.fecha_hora.strftime('%d/%m/%Y %H:%M') }}</td>
          {% if es_tic %}
            <td>{{ usuarios_dict[inc.docente_id] }}</td>
          {% endif %}
          <td class="text-end">
          <div class="d-flex gap-1 justify-content-end align-items-center">
            <a href="{{ url_for('main.editar_incidencia', id=inc.id) }}" class="btn btn-sm btn-outline-warning" title="Editar">
              <i class="bi bi-pencil-square"></i>
            </a>

            {% if inc.estado == 'Activa' %}
            <form action="{{ url_for('main.cancelar_incidencia', id=inc.id) }}" method="post" onsubmit="return confirm('¿Cancelar esta incidencia?')">
              <button type="submit" class="btn btn-sm btn-outline-danger" title="Cancelar">
                <i class="bi bi-x-circle"></i>
              </button>
            </form>
            {% endif %}

            <button class="btn btn-sm btn-outline-secondary toggle-descripcion" data-id="{{ inc.id }}" title="Ver descripción">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </td>
        </tr>
        <tr class="fila-descripcion d-none" id="descripcion-{{ inc.id }}">
          <td colspan="{% if es_tic %}7{% else %}6{% endif %}">
            <div class="alert alert-secondary mb-0">
              <strong>Descripción:</strong> {{ inc.descripcion }}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Toggle de descripción (ya lo tenías)
    document.querySelectorAll(".toggle-descripcion").forEach(btn => {
      btn.addEventListener("click", function () {
        const id = this.dataset.id;
        const fila = document.getElementById("descripcion-" + id);
        fila.classList.toggle("d-none");
      });
    });

    // Filtrado por estado
    const botonesFiltro = document.querySelectorAll(".filtro-estado");
    const tbody = document.querySelector("tbody");
    const filas = Array.from(document.querySelectorAll(".incidencia-row"));

    function aplicarFiltro(estadoFiltro) {
      // Reset botones
      botonesFiltro.forEach(b => b.classList.remove("active"));
      document.querySelector(`.filtro-estado[data-estado="${estadoFiltro}"]`).classList.add("active");

      // Filtrar
      const visibles = filas.filter(fila => {
        const estado = fila.dataset.estado;
        return estadoFiltro === "todos" || estado === estadoFiltro;
      });

      // Separar en resueltas y no resueltas
      const noResueltas = visibles.filter(f => f.dataset.estado !== "Resuelta");
      const resueltas = visibles.filter(f => f.dataset.estado === "Resuelta");

      // Ordenar por fecha descendente
      noResueltas.sort((a, b) => new Date(b.dataset.fecha) - new Date(a.dataset.fecha));
      resueltas.sort((a, b) => new Date(b.dataset.fecha) - new Date(a.dataset.fecha));

      // Limpiar y reinsertar
      tbody.innerHTML = "";
      [...noResueltas, ...resueltas].forEach(fila => {
        tbody.appendChild(fila);
        const id = fila.querySelector(".toggle-descripcion")?.dataset.id;
        const desc = document.getElementById("descripcion-" + id);
        if (desc) tbody.appendChild(desc);
      });
    }

    // Escuchar clics en botones
    botonesFiltro.forEach(btn => {
      btn.addEventListener("click", () => {
        const estado = btn.dataset.estado;
        aplicarFiltro(estado);
      });
    });

    // Inicial
    aplicarFiltro("todos");
  });
</script>
{% endblock %}