{% extends "base.html" %}

{% block title %}Nuevo Alumno{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0 text-uppercase text-secondary">Añadir nuevo alumno a {{ grupo.nombre }}</h5>
    </div>

<div class="card p-4 shadow-sm">
  <form method="POST">
    <div class="row">
      <!-- Datos personales -->
      <div class="col-md-6">
        <div class="mb-3">
          <label for="nombre" class="form-label">Nombre</label>
          <input type="text" class="form-control" id="nombre" name="nombre" required>
        </div>

        <div class="mb-3">
          <label for="apellidos" class="form-label">Apellidos</label>
          <input type="text" class="form-control" id="apellidos" name="apellidos" required>
        </div>

        <div class="mb-3">
          <label for="identificacion" class="form-label">Identificación (NIE/NIF/NRE)</label>
          <input type="text" class="form-control" id="identificacion" name="identificacion">
        </div>

        <div class="mb-3">
          <label for="direccion" class="form-label">Dirección</label>
          <input type="text" class="form-control" id="direccion" name="direccion">
        </div>
      </div>

      <!-- Contacto y observaciones -->
      <div class="col-md-6">
        <div class="mb-3">
          <label for="telefono" class="form-label">Teléfono</label>
          <input type="text" class="form-control" id="telefono" name="telefono">
        </div>

        <div class="mb-3">
          <label for="email" class="form-label">Correo electrónico</label>
          <input type="email" class="form-control" id="email" name="email">
        </div>

        <div class="mb-3">
          <label for="observaciones" class="form-label">Observaciones</label>
          <textarea class="form-control" id="observaciones" name="observaciones" rows="3"></textarea>
        </div>
      </div>
    </div>

    <hr>
    <h5 class="mt-3">Buscar responsables existentes</h5>
    <label for="responsables" class="form-label">Buscar por nombre o teléfono:</label>
    <select id="responsables" name="responsable_ids" multiple class="form-control" style="width: 100%;"></select>

    <div id="responsables-seleccionados" class="mt-3"></div>

    <hr>
    <h5 class="mt-4">Añadir nuevos responsables</h5>
    <button type="button" class="btn btn-outline-secondary mb-3" onclick="agregarNuevoResponsable()">+ Añadir nuevo responsable</button>
    <div id="nuevos-responsables"></div>

    <input type="hidden" name="principal_id" id="principal_id">

    <div class="mt-4 text-center">
      <button type="submit" class="btn btn-primary">Guardar alumno</button>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<!-- jQuery + Select2 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  $(document).ready(function () {
    $("#responsables").select2({
      width: '100%',
      ajax: {
        url: "/buscar_responsables",
        dataType: "json",
        delay: 250,
        data: function (params) {
          return { q: params.term };
        },
        processResults: function (data) {
          return { results: data };
        },
      },
      placeholder: "Escribe nombre o teléfono",
      minimumInputLength: 2,
    });

    $("#responsables").on("select2:select", function (e) {
      const selected = e.params.data;
      const id = selected.id;
      const text = selected.text;

      if (document.getElementById("radio-" + id)) return;

      const div = $(`
        <div class="form-check mt-2">
          <input class="form-check-input" type="radio" name="principal_id" value="${id}" id="radio-${id}">
          <label class="form-check-label" for="radio-${id}">Marcar como principal: ${text}</label>
        </div>
      `);
      $("#responsables-seleccionados").append(div);
    });
  });

  let nuevoIndex = 0;
  function agregarNuevoResponsable() {
    const container = document.getElementById("nuevos-responsables");
    const div = document.createElement("div");
    div.classList.add("card", "p-3", "mb-3");
    div.innerHTML = `
      <h6>Responsable nuevo</h6>
      <input type="text" name="nuevo_responsables[${nuevoIndex}][nombre]" placeholder="Nombre" class="form-control mb-1" required>
      <input type="text" name="nuevo_responsables[${nuevoIndex}][telefono]" placeholder="Teléfono" class="form-control mb-2">
      <div class="form-check">
        <input class="form-check-input" type="radio" name="principal_id" value="nuevo_${nuevoIndex}" id="radio-nuevo-${nuevoIndex}">
        <label class="form-check-label" for="radio-nuevo-${nuevoIndex}">Marcar como principal</label>
      </div>
    `;
    container.appendChild(div);
    nuevoIndex++;
  }
</script>
{% endblock %}